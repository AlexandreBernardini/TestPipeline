name: âœ… CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  COVERAGE_THRESHOLD: 90

jobs:
  # ğŸ§ª Tests et qualitÃ©
  test:
    name: ğŸ§ª Tests & Coverage
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run unit tests
        run: npm run test:unit

      - name: ğŸ”— Run integration tests
        run: npm run test:integration

      - name: âš™ï¸ Run functional tests
        run: npm test

      - name: ğŸŒ Run E2E tests
        run: npm run test:e2e

      - name: ğŸ“Š Generate coverage report
        run: npm run test:coverage

      - name: ğŸ¯ Check coverage threshold
        run: |
          COVERAGE=$(npm run test:coverage --silent --passWithNoTests | grep -oP 'All files\s+\|\s+\K\d+(?=\.\d*\s+\|)' || echo "0")
          echo "ğŸ“Š Coverage: ${COVERAGE}%"
          echo "ğŸ¯ Required: ${COVERAGE_THRESHOLD}%"
          
          if [ "${COVERAGE}" -lt "${COVERAGE_THRESHOLD}" ]; then
            echo "âŒ Coverage ${COVERAGE}% is below ${COVERAGE_THRESHOLD}% threshold"
            exit 1
          else
            echo "âœ… Coverage ${COVERAGE}% meets ${COVERAGE_THRESHOLD}% threshold"
          fi

      - name: ğŸ“¤ Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # ğŸ” QualitÃ© du code
  quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run ESLint (if configured)
        run: |
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ]; then
            echo "ğŸ” Running ESLint..."
            npx eslint src/ tests/
          else
            echo "âœ… ESLint not configured, skipping..."
          fi
        continue-on-error: false

  # ğŸ”’ SÃ©curitÃ©
  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”’ Run security audit
        run: |
          echo "ğŸ” Checking for security vulnerabilities..."
          npm audit --audit-level moderate
          echo "âœ… Security audit completed"

      - name: ğŸ›¡ï¸ Check production vulnerabilities
        run: |
          echo "ğŸ›¡ï¸ Checking production dependencies..."
          npm audit --audit-level high --production
          echo "âœ… Production security check completed"

  # ğŸ—ï¸ Build verification
  build:
    name: ğŸ—ï¸ Build & Smoke Test
    runs-on: ubuntu-latest
    needs: [test, quality, security]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build verification
        run: |
          echo "ğŸ” Verifying application syntax..."
          node -c src/app.js
          echo "âœ… Build verification successful"

      - name: ğŸ’¨ Smoke test
        run: |
          echo "ğŸš€ Starting application for smoke test..."
          timeout 30s npm start &
          APP_PID=$!
          sleep 10
          
          echo "ğŸ¥ Testing health endpoint..."
          curl -f http://localhost:3000/health
          
          echo "ğŸ’± Testing conversion endpoint..."
          curl -f "http://localhost:3000/convert?from=EUR&to=USD&amount=100"
          
          echo "ğŸ§¾ Testing VAT endpoint..."
          curl -f "http://localhost:3000/tva?ht=100&taux=20"
          
          echo "ğŸ’¸ Testing discount endpoint..."
          curl -f "http://localhost:3000/remise?prix=100&pourcentage=10"
          
          kill $APP_PID 2>/dev/null || true
          echo "âœ… Smoke tests passed"

  # ğŸ‰ Notification de succÃ¨s
  notify:
    name: ğŸ”” Success Notification
    runs-on: ubuntu-latest
    needs: [test, quality, security, build]
    if: success()

    steps:
      - name: ğŸ‰ All checks passed!
        run: |
          echo "ğŸ‰ All pipeline checks passed successfully!"
          echo "ğŸ“‹ Summary:"
          echo "  âœ… Tests: Passed"
          echo "  âœ… Code Quality: Passed" 
          echo "  âœ… Security: Passed"
          echo "  âœ… Build: Passed"
          echo "  ğŸ“Š Repository: ${{ github.repository }}"
          echo "  ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "  ğŸ“ Commit: ${{ github.sha }}"
          echo "  ğŸ‘¤ Author: ${{ github.actor }}"